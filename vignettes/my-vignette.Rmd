---
title: "Cross-Platform Microarray Meta-Analyses"
author: "Alex Pickering"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{crossmeta vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Introduction
This package helps in the meta-analysis of microarray data obtained from Gene
Expression Omnibus ([GEO](http://www.ncbi.nlm.nih.gov/gds/)).

### Obtaining Raw Data
Search GEO to find some GSEs that you want to do a meta-analysis for. For
this example, I searched for LY-294002. I restricted the search to:

* **Entry type**:Series
* **Organism**: Homo sapiens and Mus musculus
* **Study type**: Expression profiling by array

This search produced 35 hits. The following five were chosen for this example.
In practice, it is best to select all GSEs matching the necessary criteria
(supplementary raw data files available, multiple samples for each treatment,
and from either Affymetrix, Illumina, or Agilent mouse/human platforms).

After you have chosen all the GSEs that you want to run a meta-analysis on,
the next step is to obtain and uncompress the raw data:

```{r, eval=FALSE}
library(crossmeta)

#specify where data will be downloaded
data_dir <- file.path(getwd(), "data", "LY294002")

#gather GSE names into a vector for each manufacturer
affy_names  <- c("GSE9601", "GSE15069")
illum_names <- c("GSE50841", "GSE34817", "GSE29689")

#obtain the raw data(supplementary files).
get_raw_affy(affy_names, data_dir)
get_raw_illum(illum_names, data_dir)

```

After the raw data has been obtained, it's time to load it. For raw Illumina
data only, you must check that it has the correct format (and edit it if needed).

### Checking Raw Illumina Data
To help, I recommend that you download and set Sublime Text 2 as your default
text editor. It has very nice regular expression capabilities.
[Here](https://www.cheatography.com/davechild/cheat-sheets/regular-expressions/)
is a good regular expression cheat-sheat.

Ensure the following:

  * Detection p-values present(usually every second column)
  * File format is tab seperated .txt file
  * Column header formats:
    * probeid header is __ID_REF__
    * expression data headers are __AVG_Signal-sample_name__
    * pval headers are __Detection-sample_name__

Here is a function to open each Illumina raw file one-by-one with your default
text editor (Sublime Text 2 is recommended).
```{r, eval=FALSE}
illum_names <- open_raw_illum(illum_names, data_dir)
```

For **GSE50841**:

  * using Sublime Text 2, click Find --> Replace and type
  * __Find What__: _(SAMPLE \\d+)\\tDetection Pval_
  * __Replace With__: _AVG_Signal-\\1\\tDetection-\\1_


For **GSE34817**:

  * using Sublime Text 2, click Find --> Replace and type
  * __Find What__: _(MDA.+?)\\tDetection Pval_
  * __Replace With__: _AVG_Signal-\\1\\tDetection-\\1_

For **GSE29689** just change PROBE_ID to ID_REF.

### Loading Data

Now that the data is downloaded (and Illumina data is in correct format), we
must load and annotate the data. Annotation requires the ~4Gb GEOmetadb.sqlite 
file in your working directory (to lookup bioconductor annotation data packages).
Transfer it here if you have it, otherwise it will be downloaded. All
relevant bioconductor annotation data packages will also be downloaded. 

If GEOmetadb.sqlite lacks information on the bioconductor annotation data package
for a given platform, entry will be requested. Use the default entry (platform title)
to search online for the correct package name. 

For GSE29689, my version of GEOmetadb.sqlite lacked the bioconductor annotation 
data package. A popup with a default value of "Illumina HumanRef-8 v3.0 
expression beadchip" came up, so I went to [Bioconductor](https://bioconductor.org/)
and searched "illuminahuman" to find the appropriate package (illuminaHumanv3).


```{r, eval=FALSE}
affy_esets <- load_affy(affy_names, data_dir)
illum_esets <- load_illum(illum_names, data_dir)

#put esets together
esets <- c(affy_esets, illum_esets)
```

The next step is to select only features with gene symbols that are common 
between all platforms.

```{r, eval=FALSE}
com_esets <- commonize(esets)
```

### Differential Expression

We are now ready for differential expression analysis! Select control then test
samples for each contrast you want to analyse. Once done for a study, hit "Cancel"
and you will be prompted to do the same for the next study. If you re-use a 
control group for multiple contrasts in a given study, use the same combination
of tissue and group name (because it's the same group!). Analogously, do not give 
different groups the same name for contrasts within a given study.

It's useful to have a [GEO](http://www.ncbi.nlm.nih.gov/geo/) tab open in your
browser to lookup experimental details (e.g. tissue and group) for GSEs.

```{r, eval=FALSE}
anals <- diff_expr(com_esets, data_dir)
```

If you realize that you selected the wrong groups or that you need to add or remove
a GSE (and have to run `commonize` again with the updated eset list), you can 
avoid having to reselect samples and rename groups that you already selected.
For example:

```{r, eval=FALSE}
#load auto-saved results of diff_expr that you previously selected samples for
prev_names <- c("GSE9601", "GSE15069")
prev <- load_diff(prev_names, data_dir)

#supply prev to diff_expr
anals <- diff_expr(com_esets, data_dir, prev_anals=prev)
```

Multi-dimensional scaling plots are generated for each contrast. These plots
are generated from data with the effects of surrogate variables removed.

### Meta-Analysis

Now that differential expression analyses have been performed for each study,
let's combine the studies.

```{r, eval=FALSE}
#re-load previous analyses if need to
gse_names  <- c("GSE9601", "GSE15069", "GSE50841", "GSE34817", "GSE29689")
anals <- load_diff(gse_names, data_dir)

#MetaArray object (effect of SVs removed)
ma_sva <- make_ma(anals, sva=T)
```

Now the whole world of [MAMA](http://is.muni.cz/www/184415/MAMA_full.pdf) 
meta-analyses methods are available to you.

My favorite (which happens to integrate with my ccmap package - comming soon)
is shown:

```{r, eval=FALSE}
library(MAMA)

es <- ES.GeneMeta(ma_sva, "treatment", nperm=100)
```

Let's save up then go find a drug combination to reverse or mimic your signature!

ccmap (**C**ombination **C**onnectivity **M**aping comming soon)

```{r, eval=FALSE}
saveRDS(es, "LY_es.rds")
```
