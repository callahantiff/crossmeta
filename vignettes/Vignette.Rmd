---
title: "Cross-Platform Meta-Analysis of Microarrays"
author: "Alex Pickering"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{crossmeta vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  ### Introduction
  This package helps in the meta-analysis of microarray data obtained from Gene
  Expression Omnibus ([GEO](http://www.ncbi.nlm.nih.gov/geo/)).
  
  ### Obtaining Raw Data
  Search GEO to find some GSEs that you want to do a meta-analysis for. For
  this example, I searched for LY-294002. I restricted the search to:
  
  * **Entry type**: Series
  * **Organism**: Homo sapiens and Mus musculus
  * **Study type**: Expression profiling by array
  
  This search produced 35 hits. The following five were chosen for this example.
  In practice, it is best to select all GSEs matching the necessary criteria
  (supplementary raw data files available, multiple samples for each treatment,
  and from either Affymetrix, Illumina, or Agilent single channel arrays).
  
  After you have chosen all the GSEs that you want to run a meta-analysis on,
  the next step is to obtain and decompress the raw data:
  
  ```{r}
library(crossmeta)

# specify where data will be downloaded
data_dir <- file.path(getwd(), "data", "LY")

# gather GSE names; also gather Illumina GSE names in seperate vector 
# (see 'Checking Raw Illumina Data')
gse_names  <- c("GSE9601", "GSE15069", "GSE50841", "GSE34817", "GSE29689")
illum_names <- c("GSE50841", "GSE34817", "GSE29689")
```

```{r, eval=FALSE}
# download raw data
get_raw(gse_names, data_dir)
```

After the raw data has been obtained, it's time to load it. For raw Illumina
data only, you must check that it has the correct format (and edit it if needed).

### Checking Raw Illumina Data
To help, I recommend that you download and set Sublime Text 2 as your default
text editor. It has very nice regular expression capabilities.
[Here](https://www.cheatography.com/davechild/cheat-sheets/regular-expressions/)
is a good regular expression cheat-sheat.

Ensure the following:

* Detection p-values present(usually every second column)
* File format is tab seperated .txt file 
* File name includes 'non-normalized'
* Column header formats:
* probeid header is __ID_REF__
* expression data headers are __AVG_Signal-sample_name__
* pval headers are __Detection-sample_name__

The relevant raw illumina files will be in `data_dir` in a seperate folder for 
each GSE. They are usually txt files and must include 'non-normalized' in their
name. To open these files one at a time with your default text editor:

```{r, eval=FALSE}
# this is why we kept track of Illumina names in seperate vector
crossmeta:::open_raw_illum(illum_names, data_dir)
```


For **GSE50841**:

* using Sublime Text 2, click "Find --> Replace" (or "Ctrl + h")
* __Find What__: _(SAMPLE \\d+)\\tDetection Pval_
* __Replace With__: _AVG_Signal-\\1\\tDetection-\\1_


For **GSE34817**:

* using Sublime Text 2, click "Find --> Replace" (or "Ctrl + h")
* __Find What__: _(MDA.+?)\\tDetection Pval_
* __Replace With__: _AVG_Signal-\\1\\tDetection-\\1_

For **GSE29689** just change PROBE_ID to ID_REF.

A bioconductor data package (lydata) is available where all the above was 
performed. This data package will be used for subsequent demonstrations.

```{r, message=FALSE, warning=FALSE}
library(lydata)

# location of raw data
data_dir <- system.file("extdata", package = "lydata")
```

### Loading Data

Now that the data is downloaded (and Illumina data is in correct format), we
must load and annotate the data. All necessary bioconductor annotation data
packages will be downloaded on the fly. 

If crossmeta does not know the bioconductor annotation data package for a given
platform, entry will be requested. Use the given platform (GPL) to search online
for the correct package name. 

As an example, for GSE29689 (platform GPL6883) crossmeta did not know the 
bioconductor annotation data package. Entry was requested, so I went to [GEO](http://www.ncbi.nlm.nih.gov/geo/) and searched for "GPL6883". The platform 
title was "Illumina HumanRef-8 v3.0 expression beadchip" so I searched on [Bioconductor](https://bioconductor.org/) for "illuminahuman" to find the 
appropriate package (illuminaHumanv3).


```{r, message=FALSE, warning=FALSE, results='hide'}
esets <- load_raw(gse_names, data_dir = data_dir)
```


### Differential Expression

We are now ready for differential expression analysis! Select samples and supply
a group name for control/test samples for each contrast you want to analyse.
Once done for a study, hit "Done" and you will be prompted to do the same for
the next study.  You can re-select a previous control group by selecting the 
name of the group in the drop down box. You can also view and delete current 
contrasts in the "Contrasts" tab.

If you need to look up experimental detail for the study (e.g. tissue and group)
Click the `GEO` button in the top left corner.

For **Illumina** samples, rely on the supplied titles to select groups 
(accession numbers may be incorrect). The supplied titles are the headers from 
the raw data and may differ from those on GEO. As such, you may need to look in 
the individual sample records on GEO to identify which sample belongs to which
group (not always possible).

```{r, eval=FALSE}
anals <- diff_expr(esets, data_dir)
```

If you need to re-run the above analysis, you can avoid having to reselect 
samples and rename groups.

For example:

```{r, fig.height=5, fig.width=5, message=FALSE, warning=FALSE}
# load auto-saved results of previous call to diff_expr
# (In this case, all of gse_names)
prev <- load_diff(gse_names, data_dir)

# supply prev to diff_expr
# omit "[1]" to analyze all esets
anals <- diff_expr(esets[1], data_dir, prev_anals=prev)
```

Multi-dimensional scaling plots are generated for each analyzed GSE. 
These plots are generated from expression data with the effects of surrogate 
variables removed.

### Meta-Analysis

Now that differential expression analyses have been performed for each study,
let's combine the studies.

```{r, message=FALSE, warning=FALSE}
# re-load previous analyses if need to
anals <- load_diff(gse_names, data_dir)
```

The meta-analysis method determines an overall standardized effect size and 
false discovery rate for each gene that is present in a specified fraction of 
studies (30% by default). 

```{r, warning=FALSE}
# perform meta analysis
es <- es_meta(anals)
```

One application of the signature generated by this meta-analysis method is to 
search for a drug, or combination of drugs that is predicted to reverse or mimic
your signature. These drugs might reverse diseases or reproduce other desirable
states.

To predict a drug/combination to either mimic or reverse your signature, please
see the ccmap (**C**ombination **C**onnectivity **M**aping) package.
